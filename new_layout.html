<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>


        #buttons text {
            font-size: 40px;
            text-anchor: middle;
            fill: white;
        }


    </style>

</head>
<body>

    <script>

        function tree () {

            var svgWidth = 1200,
                svgHeight = 600;

            var tree = {
                cx: 600,
                cy: 30,
                w: 100,
                h: 60,
                size: 1,
                leafDepth: Infinity,
                nodes: [],
                links: []
            };

            var uniformDepth = false;
            var addNode = false;
            var removeNode = false;
            var changeText = false;

            var JSONData;
            
            //get the nodes
            tree.getNodes = function () {
                var n = [];
                function getNodes(node) {
                    n.push({ id: node.id, text: node.text, x: node.x, y: node.y, kids: node.kids, isLeaf: node.isLeaf });
                    node.kids.forEach(function (kid) { return getNodes(kid); });
                }
                getNodes(tree.nodes[0]);
                return n.sort(function (a, b) { return a.id - b.id; });
            }

            //get the links
            tree.getLinks = function () {
                var l = [];
                function getLinks(node) {
                    node.kids.forEach(function (kid) { l.push({ fromId: node.id, fromX: node.x, fromY: node.y, toId: kid.id, toX: kid.x, toY: kid.y }); });
                    node.kids.forEach(getLinks);
                }
                getLinks(tree.nodes[0]);
                return l.sort(function (a, b) { return a.toId - b.toId });
            }

            //add a new leaf
            tree.addLeaf = function (parent) {
                tree.size++;
                function addLeaf(node) {
                    if (node.id == parent) { node.kids.push({ id: tree.size-1, text: 'Node '+(tree.size - 1), x: node.x, y: node.y, kids: [], isLeaf: true }); node.isLeaf = false; return; }
                    node.kids.forEach(addLeaf);
                    redraw();
                }
                addLeaf(tree.nodes[0]);
                reposition(tree.nodes[0]);
                redraw();
            }

            //remove leaf (STILL NOT WORKING CORRECTLY)!!!
            tree.removeLeaf = function (nodeClicked) {
                var parent = tree.nodes[0];
                var visited = [];
                function removeLeaf(p) {
                    function arrangeKids(index, numOfKids) {
                        if (index < numOfKids) {
                            for (var i = index; i < parent.kids.length; i++) {
                                parent.kids[i] = parent.kids[i + 1];
                            }
                        }
                        if ((index + 1) == numOfKids == 1) {
                            parent.isLeaf = true;
                        }
                        console.log(parent.kids);
                        parent.kids.pop();
                        console.log(parent.kids);

                    }
                    if (p.id == parent.id) {
                        for (var i = 0; i < parent.kids.length; i++) {
                            if (parent.kids[i].id == nodeClicked.id) {
                                arrangeKids(i, parent.kids.length);

                                reposition(tree.nodes[0]);
                                redraw();
                                break;
                                return;
                            }
                        }
                    }
                    p.kids.forEach(removeLeaf);
                }
                function findParent(node) { //finds the parent object of the leaf clicked and saves it to parent variable
                    visited.push(node);
                    if (node.id == nodeClicked.id) { visited.pop(); parent = visited[visited.length - 1]; removeLeaf(tree.nodes[0]); }
                    node.kids.forEach(findParent);
                }

                if (nodeClicked.isLeaf) {
                    findParent(tree.nodes[0]);
                }
            }

            //change node text
            tree.changeText = function (node) {
                var newText = '';
                var num = 0;
                var textBox = d3.select("#nodes").append("foreignObject").attr("x", node.x + 50).attr("y", node.y)
                                .attr("width", 300).attr("height", 25).append("xhtml:form")
                                .append("input").attr("value", function () { this.focus(); return node.text })
                                .on("blur", function () {
                                    newText = textBox.node().value;
                                    function changeText(n) {
                                        if (n.id == node.id) { n.text = newText; return; }
                                        n.kids.forEach(changeText);
                                    }
                                    tree.nodes[0].kids.forEach(changeText);
                                    redraw();
                                    d3.select("foreignObject").remove();
                                    
                                })
                                .on("keypress", function () { 
                                    if (d3.event.keyCode == 13) {
                                        var e = d3.event;
                                        //prevents the entire tree from deleting when enter is pressed
                                        if (e.stopPropagation) { e.stopPropagation(); }
                                        e.preventDefault();

                                        newText = textBox.node().value;
                                        tree.nodes[0].kids.forEach(function (kid) {
                                            if (kid.id == node.id) { kid.text = newText; }
                                        });
                                        redraw();
                                        d3.select("foreignObject").remove();
                                    }
                                });
            }

            //sets leafs depth to deepest leaf
            tree.nodeDepth = function () {
                var leafs = [];
                var depth = 0;
                
                //check if nodes are leafs
                function nodeDepth(n) {
                    n.kids.forEach(function (kid) {
                        if (kid.isLeaf) { leafs.push({ id: kid.id });
                            if (kid.y > depth) { depth = kid.y; }
                        }
                    });
                    n.kids.forEach(nodeDepth);
                }
                nodeDepth(tree.nodes[0]);
                function changeDepth(n) {
                    n.kids.forEach(function (kid) {
                        leafs.forEach(function (leaf) { if (kid.id == leaf.id) { kid.y = depth; } })
                        
                    });
                    n.kids.forEach(changeDepth);
                }
                changeDepth(tree.nodes[0]);
                tree.leafDepth = depth;
            }

            //redraw the tree
            redraw = function () {
                //this refreshes the svg groups to allow for 
                d3.select('#nodes').selectAll('text').data(tree.getNodes()).exit().remove();
                d3.select('#links').selectAll('line').data(tree.getLinks()).exit().remove();
                var nodes = d3.select('#nodes').selectAll('text').data(tree.getNodes());


                nodes.text(function (node) { return node.text }).transition().duration(500)
                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
                    .attr('fill', function (node) { if (node.isLeaf) { return 'red'; } else { return 'blue'; } });

                nodes.enter().append('text').attr('id', function (node) { return node.id; })
                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
                    .text(function (node) { return node.text; })
                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
                    .on('click', function (node) { if (d3.event.shiftKey) { return tree.changeText(node); } else if (d3.event.ctrlKey) { return tree.removeLeaf(node); } else { return tree.addLeaf(node.id); } })
                    .transition().duration(500)
                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; });


                var links = d3.select('#links').selectAll('line').data(tree.getLinks());

                links.transition().duration(500)
                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })
                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });

                links.enter().append('line')
                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })
                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; })
                    .style({ 'stroke': 'lightgray', 'stroke-width': '3px' })
                    .transition().duration(500)
                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });
                    

            }

            //get leaf count for node
            getLeafCount = function (node) {
                if (node.kids.length == 0) { return 1; }
                else { return node.kids.map(getLeafCount).reduce(function (a, b) { return a + b; }); }
            }

            //update node positions
            reposition = function (node) {

                if (uniformDepth) {
                    tree.nodeDepth();
                }

                var leafCount = getLeafCount(node),
                    left = node.x - tree.w * (leafCount - 1) / 2;
                node.kids.forEach(function (kid) {
                    var w = tree.w * getLeafCount(kid);
                    left += w;
                    kid.x = left - (w + tree.w) / 2;
                    kid.y = node.y + tree.h;
                    reposition(kid);
                    redraw();
                });
                
            }

            //convert svgTree to image 
            svgToImage = function () {
                //get svg element.
                var svg = d3.select("svg")[0][0];

                //get svg source.
                var serializer = new XMLSerializer();
                var source = serializer.serializeToString(svg);

                //add name spaces.
                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                //add xml declaration
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

                //convert svg source to URI data scheme.
                var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

                //open the image in a new tab
                var win = window.open(url, '_blank');
                win.focus();
/*
                // Select the first svg element
                var svg = d3.select("svg")[0][0],
                    img = new Image(),
                    serializer = new XMLSerializer(),
                    svgStr = serializer.serializeToString(svg);
                console.log(svg);

                img.src = 'data:image/svg+xml;base64,' + window.btoa(svgStr);

                // You could also use the actual string without base64 encoding it:
                //img.src = "data:image/svg+xml;utf8," + svgStr;

                var canvas = document.createElement("canvas");
                document.body.appendChild(canvas);

                canvas.width = svgWidth;
                canvas.height = svgHeight;
                canvas.getContext("2d").drawImage(img, 0, 0, svgWidth, svgHeight);
                // Now save as png or whatever
*/
/*
                var svg = document.querySelector("svg");
                var svgData = new XMLSerializer().serializeToString(svg);

                var canvas = document.createElement("canvas");
                canvas.width = 1200;
                canvas.height = 600;
                var ctx = canvas.getContext("2d");

                var img = document.createElement("img");
                img.setAttribute("src", "data:image/svg+xml;base64," + btoa(svgData));

                img.onload = function () {
                    ctx.drawImage(img, 0, 0);

                    // Now is done
                    console.log(canvas.toDataURL("image/png"));
                };
*/

            }

            //save the tree structure as JSON
            saveTree = function () {
                JSONData = JSON.stringify(tree.nodes);
                //console.log(JSONData);
                loadTree();
            }

            //save the tree structure as JSON
            loadTree = function () {
                tree.nodes = JSON.parse(JSONData);
                reposition(tree.nodes[0]);
                redraw();
            }

            resetTree = function () {
                tree.nodes = [];
                tree.nodes.push({ id: 0, text: 'Clause', x: tree.cx, y: tree.cy, kids: [], isLeaf: false });
                reposition(tree.nodes[0]);
                redraw();
            }

            //set up the page
            initialise = function () {


                //add the root node
                tree.nodes.push({ id: 0, text: 'Clause', x: tree.cx, y: tree.cy, kids: [], isLeaf: false });

                //create the svg
                d3.select('body').style({ 'width': '1200px', 'margin': '10px auto' }).append('svg').attr('width', svgWidth).attr('height', svgHeight).attr('id', 'svgTree')
                    .style({ 'border': '1px solid gray' });

                //create group of nodes
                d3.select('#svgTree').append('g').attr('id', 'nodes').selectAll('text').data(tree.getNodes())
                    .enter().append('text').attr('id', function (node) { return node.id; })
                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
                    .text(function (node) { return node.text; })
                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
                    .on('click', function (node) { return tree.addLeaf(node.id); });

                //create group of links
                d3.select('#svgTree').append('g').attr('id', 'links').selectAll('line').data(tree.getLinks())
                    .enter().append('line')
                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY; })
                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY; });
                    
                console.log(tree.getLinks());
                if ((tree.getLinks()).length > 0) {
                    console.log('Yep');
                    d3.select('#svgTree').getElementById('links').selectAll('line').data(tree.getLinks())
                    .enter().style('stroke:rgb(255,0,0);stroke-width:2;');
                }
                //Show the legend in top left corner
                var controlsInfo = [
                    { action: 'Add Leaf : ', buttons: ' Click on a Node', x: 5, y: 15 },
                    { action: 'Remove Leaf : ', buttons: ' Hold Ctrl & Click on a Leaf', x: 5, y: 30 },
                    { action: 'Change Node Text : ', buttons: ' Hold Shift & Click on a Node', x: 5, y: 45 }
                ];
                d3.select('#svgTree').append('g').attr('id', 'legend').selectAll('text').data(controlsInfo)
                    .enter().append('text')
                    .attr('x', function (c) { return c.x; }).attr('y', function (c) { return c.y; }).attr('font-size', 12).text(function (c) { return c.action; }).append('tspan').attr('x', 120).attr('y', function (c) { return c.y; }).text(function (c) { return c.buttons; });
                    
                //Show Buttons (Save etc.)
                var svg = d3.select('#svgTree').append('g').attr('id', 'buttons');
                var text = svg.append('text').text('Save').attr('dy', '1em').attr('transform', 'translate(1150,540)')
                            .on('click', function () { saveTree(); });
                var ctm = text[0][0].getCTM(),
                    box = text[0][0].getBBox();
                var rect = svg.insert('rect', 'text').attr('x', (box.x - 5)).attr('y', (box.y - 5)).attr('width', box.width + 10).attr('height', box.height + 10)
                    .style({ 'fill': 'green' });
                setTM = function (element, m) {
                    return element.transform.baseVal.initialize(element.ownerSVGElement.createSVGTransformFromMatrix(m));
                };
                setTM(rect[0][0], ctm);

                //Easy buttons at the bottom of the page
                d3.select("body")
                    .append("button")
                    .html("Export")
                    .on("click", svgToImage);

                d3.select("body")
                    .append("button")
                    .html("Save")
                    .on("click", saveTree);

                d3.select("body")
                    .append("button")
                    .html("Load")
                    .on("click", loadTree);

                d3.select("body")
                    .append("button")
                    .html("Reset")
                    .on("click", resetTree);

                d3.select("body")
                    .append("button")
                    .html("Depth")
                    .on("click", function () { if (uniformDepth) { uniformDepth = false; } else { uniformDepth = true; } reposition(tree.nodes[0]); redraw(); } );

                d3.select("body")
                    .append("button").attr('id', 'addNode')
                    .html("Add Node")
                    .on("click", function () {
                        if (!addNode) {
                            addNode = true; document.getElementById('addNode').style.background = '#ccc';
                            removeNode = false; document.getElementById('removeNode').style.background = '#ddd';
                            changeText = false; document.getElementById('changeText').style.background = '#ddd';
                        }
                    });

                d3.select("body")
                    .append("button").attr('id', 'removeNode')
                    .html("Remove Node")
                    .on("click", function () {
                        if (!removeNode) {
                            addNode = false; document.getElementById('addNode').style.background = '#ddd';
                            removeNode = true; document.getElementById('removeNode').style.background = '#ccc';
                            changeText = false; document.getElementById('changeText').style.background = '#ddd';
                        }
                    });

                d3.select("body")
                    .append("button").attr('id', 'changeText')
                    .html("Change Text")
                    .on("click", function () {
                        if (!changeText) {
                            addNode = false; document.getElementById('addNode').style.background = '#ddd';
                            removeNode = false; document.getElementById('removeNode').style.background = '#ddd';
                            changeText = true; document.getElementById('changeText').style.background = '#ccc';
                        }
                    });

                redraw();
            }

            initialise();

            return tree;
        }
        var tree = tree();

    </script>

    

</body>
</html>